enchant();


var mapData1_0 = [
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],

    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],

    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],

    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9],
    [ 9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9,      9,  9,  9,  9,  9,     9,  9,  9,  9,  9]
];

var mapData1_1 = [
    [ 5,  5,  5,  5, 5,      5,  5,  5,  5,  5,      5,  5,  5, 5,  5,     5,  5,   5,  5,  5,      5,  5,  5,  5,  5,     5,  5,  5,  5,  5,],
    [ 5,  5,  5,  5, 5,      5,  5,  5,  5,  5,      5,  5,  5,  5, 5,     5,  5,   5,  5,  5,      5,  5,  5,  5,  5,     5,  5,  5,  5,  5,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],

    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [ 4,  4,  4,  4,  4,     4,  4,  4,  4,  4,      4,  4,  3, 10, 10,    10, 10,  3,  4,  4,      4,  4,  4,  4,  4,     4,  4,  4,  4,  4,],
    [-1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1,  3, 10, 10,    10, 10,  3 , -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,],
    [-1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1,  3, 10, 10,    10, 10,  3, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,],

    [-1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1,  3, 10, 10,    10, 10,  3, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,],
    [-1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1,  3, 10, 10,    10, 10,  3, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,],
    [ 4,  4,  4,  4,  4,     4,  4,  4,  4,  4,      4,  4,  4, 10, 10,    10, 10,  4,  4,  4,      4,  4,  4,  4,  4,     4,  4,  4,  4,  4,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],

    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,     10, 10, 10, 10, 10,    10, 10, 10, 10, 10,],
    [-1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,],
    [-1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,     -1, -1, -1, -1, -1,    -1, -1, -1, -1, -1,]
];

var mapData1_col = [
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 1,  1,  1,  1,  1,     1,  1,  1,  1,  1,      1,  1,  1,  1,  1,     1,  1,  1,  1,  1,      1,  1,  1,  1,  1,     1,  1,  1,  1,  1,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],

    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0, ã€€0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 1,  1,  1,  1,  1,     1,  1,  1,  1,  1,      1,  1,  1,  0,  0,     0,  0,  1,  1,  1,      1,  1,  1,  1,  1,     1,  1,  1,  1,  1,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  1,  0,  0,     0,  0,  1,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  1,  0,  0,     0,  0,  1,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],

    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  1,  0,  0,     0,  0,  1,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  1,  0,  0,     0,  0,  1,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 1,  1,  1,  1,  1,     1,  1,  1,  1,  1,      1,  1,  1,  0,  0,     0,  0,  1,  1,  1,      1,  1,  1,  1,  1,     1,  1,  1,  1,  1,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],

    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,],
    [ 1,  1,  1,  1,  1,     1,  1,  1,  1,  1,      1,  1,  1,  1,  1,     1,  1,  1,  1,  1,      1,  1,  1,  1,  1,     1,  1,  1,  1,  1,],
    [ 0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,      0,  0,  0,  0,  0,     0,  0,  0,  0,  0,]
];


var map_aster;
var graph;


Position = function(x, y){
    this.x = Math.floor(x / 16);
    this.y = Math.floor(y / 16);
}


Monster = Class.create(Sprite, {
    initialize: function(x, y, target){
        Sprite.call(this, 32, 32);
        this.image = game.assets['./img/chara0.png'];
        this.frame = [7];
        this.x = x;
        this.y = y;
        this.speed = 1;
        this.target = target;
        this.current_x = Math.floor((this.x + 16) / 16);
        this.current_y = Math.floor((this.y + 32) / 16);
    },
    tracking: function(){
        if(this.current_x == this.target_x && this.current_y == this.target_y){
            return;
        }
        if(this.old_target_x != this.target_x || this.old_target_y != this.target_y){
            this.old_target_x = this.target_x;
            this.old_target_y = this.target_y;
            var start = graph.grid[this.current_y][this.current_x];
            var end = graph.grid[this.target_y][this.target_x];
            this.shortestPath = astar.search(graph, start, end);
            /*for(var i = 0; i < this.shortestPath.length;i++){
                console.log(this.shortestPath[i]);
            }*/
            this.step = 0;
            console.log(this.current_x, this.current_y, this.target_x, this.target_y, "bug");
            this.next_x = this.shortestPath[this.step].y;
            this.next_y = this.shortestPath[this.step].x;
            //console.log(this.next_x, this.next_y);
        }else{
            if(this.current_y == this.next_y && this.current_x == this.next_x){
                this.step++;
                this.next_x = this.shortestPath[this.step].y;
                this.next_y = this.shortestPath[this.step].x;
            }
        }

        if(this.current_y < this.next_y){
            this.y += this.speed;
        }else if(this.current_y > this.next_y){
            this.y -= this.speed;
        }

        if(this.current_x < this.next_x){
            this.x += this.speed;
        }else if(this.current_x > this.next_x){
            this.x -= this.speed;
        }
        //console.log(this.current_x, this.current_y, this.next_x, this.next_y);
    },
    onenterframe: function(){
        this.current_x = Math.floor((this.x + 16) / 16);
        this.current_y = Math.floor((this.y + 32) / 16);
        this.target_x = Math.floor((this.target.x + 16) / 16);
        this.target_y = Math.floor((this.target.y + 32) / 16);
        this.tracking();
        console.log(this.current_x, this.current_y, this.target_x, this.target_y);
        //this.tracking(Math.floor((this.target.x + 16) / 16), Math.floor((this.target.y + 16) / 16));
    }
});


Player = Class.create(Sprite, {
    initialize: function(x, y){
        Sprite.call(this, 32, 32);
        this.image = game.assets['./img/chara0.png'];
        this.setPos(x, y);
        this.speed = 3;
        this.directionX = 0;
        this.directionY = 0
        this.movingFlag = false;
        this.direction = 1;
    },
    setPos: function(x, y){
        this.x = x;
        this.y = y;
        this.frame = [4];
        //this.enable();
    },
    enable: function(){
        this.flag = true;
    },
    disable: function(){
        this.flag = false;
    },
    getCurrentPos: function(){
        var ret = new Position(this.x + 16, this.y + 16);
        return ret;
    },
    onenterframe: function(){
        this.movingFlag = false;

        if(!this.movingFlag){
            if(game.input.up){
                this.y -= this.speed;
                this.movingFlag = true;
                this.frame = [31, 31, 31, 30, 30, 30, 31, 31, 31, 32, 32, 32];
                this.direction = -1;
            }
        }
        if(!this.movingFlag){
            if(game.input.right){
                if(this.movingFlag) {
                    return;
                }
                this.x += this.speed;
                this.movingFlag = true;
                this.frame = [22, 22, 22, 21, 21, 21, 22, 22, 22, 23, 23, 23];
                this.direction = 2;
            }
        }
        if(!this.movingFlag){
            if(game.input.left){
                if(this.movingFlag) {
                    return;
                }
                this.x -= this.speed;
                this.movingFlag = true;
                this.frame = [13, 13, 13, 12, 12, 12, 13, 13, 13, 14, 14, 14];
                this.direction = -2;
            }
        }
        if(!this.movingFlag){
            if(game.input.down){
                this.y += this.speed;
                this.movingFlag = true;
                this.frame = [4, 4, 4, 3, 3, 3, 4, 4, 4, 5, 5, 5];
                this.direction = 1;
            }
        }

        if(this.movingFlag == false){
            switch(this.direction){
                case -1: this.frame = [31]; break;
                case  2: this.frame = [22];break;
                case -2: this.frame = [13];break;
                case  1: this.frame = [4];break;
            }
        }

        if (map.hitTest(this.x + 10, this.y + 20) ||                     // upper left
            map.hitTest(this.x + this.width - 10, this.y + 20) ||        // upper right
            map.hitTest(this.x + 10, this.y + this.height) ||            // lower left
            map.hitTest(this.x + this.width - 10, this.y + this.height)  // lower right
            === true) {
            switch(this.direction){
                case -1: this.y += this.speed; break;
                case  2: this.x -= this.speed;break;
                case -2: this.x += this.speed;break;
                case  1: this.y -= this.speed;break;
            }
        }
        //var pos = this.getCurrentPos();
        //console.log();
    }
});


BreakFace = Class.create({
    initialize: function(){
        map = new Map(16, 16);
        scene_game = new Scene();

        this.mapWidth = 30;
        this.mapHeight = 20;

        map.image = game.assets['./img/map0.png'];
        map.loadData(mapData1_0, mapData1_1);
        map.collisionData = mapData1_col;
        map_aster = new Array(this.mapHeight);
        for(i = 0; i < this.mapHeight; i++){
            map_aster[i] = new Array(this.mapWidth);
            for(j = 0; j < this.mapWidth; j++){
                if(mapData1_col[i][j] === 0){
                    map_aster[i][j] = 1;
                }else{
                    map_aster[i][j] = 0;
                }
            }
        }
        graph = new Graph(map_aster);

        player = new Player(50, 50);
        monster = new Monster(330, 208, player);
        monster.tracking(player.getCurrentPos());

        scene_game.addChild(map);
        scene_game.addChild(player);
        scene_game.addChild(monster);

        game.pushScene(scene_game);
    },
});


window.onload = function () {
    game = new Game(480, 320);
    game.preload('./img/map0.png', './img/chara0.png');

    game.onload = function () {
        game.keybind('s'.charCodeAt(0), 's');

        scene_top = new Scene();
        label_title = new Label();
        label_title.x = 300;
        label_title.y = 50;
        label_title.scaleX = 2.0;
        label_title.scaleY = 2.0;
        label_title.text = "BREAK FACE";
        scene_top.addChild(label_title);

        scene_top.addEventListener('touchend', function(){
            breakface = new BreakFace();
        });

        game.pushScene(scene_top);
    };
    game.start();
};
